<!DOCTYPE html>
<html>
  <style>
    body {
      padding: 20px 30px;
      background-color: #e9e9e9;
    }
    .header {
      margin-bottom: 10px;
    }
    .header>a {
      margin-right: 10px;
    }
    .buttons {
      margin-bottom: 10px;
    }
    .btn {
      padding: 5px 10px;
      background-color: #FFF;
      border: 1px solid #999;
      font-size: 18px;
      margin-right: 10px;
    }
    .log {
      font-size: 18px;width:98%;padding:1%;
    }
  </style>
<body>
  <div class="header">
    <a href="/">Home</a>
    <a>Assets</a>
  </div>
  <div class="buttons">
    <button id="params" class="btn" disabled>AlgoSigner.algod('params')</button>
    <button id="accounts" class="btn" disabled>AlgoSigner.accounts('TestNet')</button>
    <button id="sign" class="btn" disabled>AlgoSigner.sign(acfg)</button>
    <button id="optin" class="btn" disabled>AlgoSigner.sign(12183596 optin)</button>
    <button id="post" class="btn" disabled>AlgoSigner.send(tx.blob)</button>
    <button id="connect" class="btn">AlgoSigner.connect()</button>
  </div>
  <textarea id="log" class="log" rows="38">
Select 'AlgoSigner.connect()' - authorize the dApp in AlgoSigner
Select 'AlgoSigner.accounts("TestNet")' - provides the dApp an array of TestNet accounts from the wallet
Select 'AlgoSigner.algod("params")' - populates the transaction parameters like 'first-round', 'last-round' and 'genesisID'
Select 'AlgoSigner.sign(acfg)' - sends an ASA creation transaction to AlgoSigner for review and approval (requires password). The dApp gets back a signed transaction.
Select 'AlgoSigner.sign(12183596 optin)' - sends an ASA axfer optin transaction to AlgoSigner to opt-in for ASA 12183596 for review and approval (requires password). The dApp gets back a signed transaction.
Select 'AlgoSigner.send(tx.blob)' - dApp sends the signed transaction blob (in base64) - back to AlgoSigner for submission to the network
Select 'AlgoSigner.algod('pending transaction') - verify the status of the transaction
  </textarea>
  <div class="buttons">
  </div>

  <script>
    let txParams = {};
    let accounts = [];
    let signedTx;
    let txId = '';
    let resolved_info = "[V] Promised resolved:\n";
    let catched_info = "[X] Promised caught:\n";

    function sign(){
      const amount = Math.floor(Math.random() * 10); 

      let txn = {
        "from": accounts[0].address,
        "assetTotal": 1000,
        "fee": txParams['min-fee'],
        "assetUnitName": "ts",
        "assetName": "Testy",
        "type": "acfg",
        "firstRound": txParams['last-round'],
        "lastRound": txParams['last-round'] + 1000,
        "genesisID": txParams['genesis-id'],
        "genesisHash": txParams['genesis-hash'],
        "note": "note"
      };
      AlgoSigner.sign(txn)
      .then((d) => {
        console.log(d);
        document.getElementById("log").value += resolved_info;
        document.getElementById("log").value += JSON.stringify(d) + "\n\n";
        signedTx = d;

        let blobUint8 = Uint8Array.from(atob(d.blob).split("").map(x => x.charCodeAt(0)));
        document.getElementById("log").value += `Blob Uint8Array: ${blobUint8}\n\n`;
      })
      .catch((e) => {
        console.error(e);
        document.getElementById("log").value += catched_info;
        document.getElementById("log").value += JSON.stringify(e) + "\n\n";
      });
    }

    function optIn(){
      let txn = {
        "from": accounts[0].address,
        "to": accounts[0].address,
        "assetIndex": 12183596,
        "amount": 0,
        "type": "axfer",
        "fee": txParams['min-fee'],
        "firstRound": txParams['last-round'],
        "lastRound": txParams['last-round'] + 1000,
        "genesisID": txParams['genesis-id'],
        "genesisHash": txParams['genesis-hash'],
        "note": "note"
      };
      AlgoSigner.sign(txn)
      .then((d) => {
        console.log(d);
        document.getElementById("log").value += resolved_info;
        document.getElementById("log").value += JSON.stringify(d) + "\n\n";
        signedTx = d;

        let blobUint8 = Uint8Array.from(atob(d.blob).split("").map(x => x.charCodeAt(0)));
        document.getElementById("log").value += `Blob Uint8Array: ${blobUint8}\n\n`;
      })
      .catch((e) => {
        console.error(e);
        document.getElementById("log").value += catched_info;
        document.getElementById("log").value += JSON.stringify(e) + "\n\n";
      });
    }

    function postTx(){
      AlgoSigner.send({
        ledger: 'TestNet',
        tx: signedTx.blob
      })
      .then((d) => {
        console.log(d)
        document.getElementById("log").value += resolved_info;
        document.getElementById("log").value += JSON.stringify(d) + "\n\n";
        txId = d;
      })
      .catch((e) => {
        console.error(e);
        document.getElementById("log").value += catched_info;
        document.getElementById("log").value += JSON.stringify(e) + "\n\n";
      });
    }

    function getAccounts(){
      AlgoSigner.accounts({ledger: 'TestNet'})
      .then((d) => {
        document.getElementById("log").value += resolved_info;
        document.getElementById("log").value += JSON.stringify(d) + "\n\n";
        accounts = d;
      })
      .catch((e) => {
        console.error(e);
        document.getElementById("log").value += catched_info;
        document.getElementById("log").value += JSON.stringify(e) + "\n\n";
      });
    }

    function params(){
      AlgoSigner.algod({
        ledger: 'TestNet',
        path: '/v2/transactions/params'
      })
      .then((d) => {
        document.getElementById("log").value += resolved_info;
        document.getElementById("log").value += JSON.stringify(d) + "\n\n";
        txParams = d;
      })
      .catch((e) => {
        console.error(e);
        document.getElementById("log").value += catched_info;
        document.getElementById("log").value += JSON.stringify(e) + "\n\n";
      });
    }

    function connect() {

      AlgoSigner.connect()
      .then((d) => {
        let el = document.getElementById('sign');
        el.disabled = false;
        el.addEventListener("click",() => {
          sign();
        }, false);

        el = document.getElementById('post');
        el.disabled = false;
        el.addEventListener("click",() => {
          postTx();
        }, false);

        el = document.getElementById('params');
        el.disabled = false;
        el.addEventListener("click",() => {
          params();
        }, false);

        el = document.getElementById('optin');
        el.disabled = false;
        el.addEventListener("click",() => {
          optIn();
        }, false);

        el = document.getElementById('accounts');
        el.disabled = false;
        el.addEventListener("click",() => {
          getAccounts();
        }, false);

        el = document.getElementById('connect');
        el.disabled = true;
      })
      .catch((e) => {
        let el = document.getElementById('connect');
        console.error(e);
        document.getElementById("log").value += catched_info;
        document.getElementById("log").value += JSON.stringify(e) + "\n\n";
      });
    }

    let el = document.getElementById('connect');
    el.addEventListener("click", connect, false);
  </script>
</body>
</html>