<!DOCTYPE html>
<html>
    <style>
        body {
            padding: 40px;
            background-color: #e9e9e9;
        }
        .buttons {
            width:100%;
            margin-bottom: 10px;
        }
        .buttons .btn {
            display: inline;
        }
        .btn {
            padding: 5px 10px;
            background-color: #FFF;
            border: 1px solid #999;
            font-size: 18px;
            margin-right: 10px;
        }
        .log {
            font-size: 18px;width:98%;padding:1%;
        }
    </style>
<body>
    <div class="buttons">
            <button id="status" class="btn" disabled>AlgoSigner.algod('status')</button>
            <button id="params" class="btn" disabled>AlgoSigner.algod('params')</button>
            <button id="accounts" class="btn" disabled>AlgoSigner.accounts('TestNet')</button>
            <button id="sign" class="btn" disabled>AlgoSigner.sign()</button>
            <button id="post" class="btn" disabled>AlgoSigner.algod('transaction', POST)</button>
            <button id="connect" class="btn">AlgoSigner.connect()</button>
    </div>
    <textarea id="log" class="log" rows="38"></textarea>
    <script>
        (() => {
            let txParams = {};
            let accounts = [];
            let signedTx;
            let resolved_info = "[V] Promised resolved:\n";
            let catched_info = "[X] Promised caught:\n";

            function sign(){
                // {amount: 100,to: "6BJJ3ESASBS2UVHSEBYD6WD2HDRLYUIRPGJK2JJYZ6CMW6L3DHZYHYHWJU"}
                let txn = {
                  "from": accounts[0].address,
                  "to": "PBZHOKKNBUCCDJB7KB2KLHUMWCGAMBXZKGBFGGBHYNNXFIBOYI7ONYBWK4",
                  "fee": txParams['min-fee'],
                  "ledger": "TestNet",
                  "amount": 12345,
                  "firstRound": txParams['last-round'],
                  "lastRound": txParams['last-round'] + 1000,
                  "genesisID": txParams['genesis-id'],
                  "genesisHash": txParams['genesis-hash'],
                  "note": new Uint8Array(0)
                };
                AlgoSigner.sign(txn)
                .then((d) => {
                    document.getElementById("log").value += resolved_info;
                    document.getElementById("log").value += JSON.stringify(d) + "\n\n";
                    signedTx = d;
                })
                .catch((e) => {
                    console.error(e);
                    document.getElementById("log").value += catched_info;
                    document.getElementById("log").value += JSON.stringify(e) + "\n\n";
                });
            }

            function postTx(){

                AlgoSigner.algod({
                    ledger: 'TestNet',
                    path: '/v2/transactions',
                    method: 'POST',
                    contentType: 'application/x-binary',
                    body: signedTx
                })
                .then((d) => {
                    document.getElementById("log").value += resolved_info;
                    document.getElementById("log").value += JSON.stringify(d) + "\n\n";
                })
                .catch((e) => {
                    console.error(e);
                    document.getElementById("log").value += catched_info;
                    document.getElementById("log").value += JSON.stringify(e) + "\n\n";
                });
            }

            function status(){
                AlgoSigner.algod({
                    ledger: 'TestNet',
                    path: '/v2/status'
                })
                .then((d) => {
                    document.getElementById("log").value += resolved_info;
                    document.getElementById("log").value += JSON.stringify(d) + "\n\n";
                })
                .catch((e) => {
                    console.error(e);
                    document.getElementById("log").value += catched_info;
                    document.getElementById("log").value += JSON.stringify(e) + "\n\n";
                });
            }

            function getAccounts(){
                AlgoSigner.accounts({ledger: 'TestNet'})
                .then((d) => {
                    document.getElementById("log").value += resolved_info;
                    document.getElementById("log").value += JSON.stringify(d) + "\n\n";
                    accounts = d;
                })
                .catch((e) => {
                    console.error(e);
                    document.getElementById("log").value += catched_info;
                    document.getElementById("log").value += JSON.stringify(e) + "\n\n";
                });
            }

            function params(){
                AlgoSigner.algod({
                    ledger: 'TestNet',
                    path: '/v2/transactions/params'
                })
                .then((d) => {
                    document.getElementById("log").value += resolved_info;
                    document.getElementById("log").value += JSON.stringify(d) + "\n\n";
                    txParams = d;
                })
                .catch((e) => {
                    console.error(e);
                    document.getElementById("log").value += catched_info;
                    document.getElementById("log").value += JSON.stringify(e) + "\n\n";
                });
            }

            function connectListener(ev) {
                connect();
            }

            function connect() {

                AlgoSigner.connect()
                .then((d) => {
                    let el = document.getElementById('sign');
                    el.disabled = false;
                    el.addEventListener("click",() => {
                        sign();
                    }, false);

                    el = document.getElementById('post');
                    el.disabled = false;
                    el.addEventListener("click",() => {
                        postTx();
                    }, false);

                    el = document.getElementById('status');
                    el.disabled = false;
                    el.addEventListener("click",() => {
                        status();
                    }, false);

                    el = document.getElementById('params');
                    el.disabled = false;
                    el.addEventListener("click",() => {
                        params();
                    }, false);

                    el = document.getElementById('accounts');
                    el.disabled = false;
                    el.addEventListener("click",() => {
                        getAccounts();
                    }, false);

                    el = document.getElementById('connect');
                    el.disabled = true;
                })
                .catch((e) => {
                    let el = document.getElementById('connect');
                    el.disabled = false;
                    el.removeEventListener("click",connectListener);
                    el.addEventListener("click",connectListener, false);
                    console.error(e);
                    document.getElementById("log").value += catched_info;
                    document.getElementById("log").value += JSON.stringify(e) + "\n\n";
                });
            }

            // setTimeout(() => {
            //     connect();
            // },100);
            let el = document.getElementById('connect');
            el.addEventListener("click", connect, false);
        })();
    </script>
</body>
</html>